<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qiyu.dao.IActivityDao">
		<resultMap type="com.qiyu.bean.Activity" id="BaseResultMap">
			<id column="id" property="id" jdbcType="BIGINT" />
		    <result column="title" property="title" jdbcType="VARCHAR" />
		    <result column="building_id" property="buildingId" jdbcType="BIGINT" />
		    <result column="store_id" property="storeId" jdbcType="BIGINT" />
		    <result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
		    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
		    <result column="phone" property="phone" jdbcType="VARCHAR" />
		    <result column="reminder_time" property="reminderTime" jdbcType="VARCHAR" />
		    <result column="pic" property="pic" jdbcType="VARCHAR" />
		    <result column="introduce" property="introduce" jdbcType="VARCHAR" />
		    <result column="tag" property="tag" jdbcType="VARCHAR" />
		    <result column="cover" property="cover" jdbcType="VARCHAR" />
		</resultMap>
		
		<resultMap type="com.qiyu.bean.Activity" id="getActivityMap" extends="BaseResultMap">
			<collection property="coverList" column="cover" select="getfile"></collection>
			<collection property="picList" column="pic" select="getfile"></collection>
		</resultMap>
		
		<sql id="Base_Column_List">
			id,title,building_id,store_id,
			DATE_FORMAT(start_time,'%Y-%m-%d %H:%i:%s') start_time,
			DATE_FORMAT(end_time,'%Y-%m-%d %H:%i:%s') end_time,
			phone,create_time,reminder_time,pic,introduce,tag,cover,sign_up_ids
		</sql>
		
		<resultMap type="com.qiyu.bean.Activity" id="getUserActivityListMap" extends="BaseResultMap">
			<result column="building_adress" property="buildingAdress" jdbcType="VARCHAR" />
			<association property="Store" column="store_id" select="com.qiyu.dao.IStoreDao.getStore"></association>
			<collection property="picList" column="pic" select="getfile"></collection>
		</resultMap>
			
			<resultMap type="com.qiyu.bean.Activity" id="getActivityDetailMap" extends="BaseResultMap">
			 <result column="building_logo" property="buildingLogo" jdbcType="VARCHAR" />
			 <result column="building_adress" property="buildingAdress" jdbcType="VARCHAR" />
			<association property="Store" column="store_id" select="com.qiyu.dao.IStoreDao.getStore"></association>
			<collection property="picList" column="pic" select="getfile"></collection>
		</resultMap>
		
		
		<select id="getfile" parameterType="java.util.Map" resultType="com.qiyu.bean.FileInfo">
			select id,url from file where find_in_set(id,#{ids})		
		</select>

		<insert id="addActivity" parameterType="java.util.Map">
			insert into activity(
				title,building_id,store_id,	start_time,	end_time,  phone, reminder_time, pic, introduce,tag,cover,sign_up_ids	
			) 
			values(
			 #{title}, #{buildingId}, #{storeId}, #{startTime},	 #{endTime} ,  #{phone},  #{reminderTime},	#{pic}, #{introduce} , #{tag}, #{cover},'[]'
			)
			
		</insert>
		
		
		<delete id="delActivity" parameterType="java.util.Map">
			delete from activity where id =#{id}  <if test="level !=null and ( level ==2 or level == '2')"> and building_id =#{buildingId} </if>	
		</delete>
		
		
		<update id="updateActivity" parameterType="java.util.Map">
			update activity 
			<set>
				<if test="title !=null"> title  =#{title}, </if> 
				<if test="phone !=null">  phone =#{phone}, </if>
				<if test="pic !=null"> pic=#{pic}, </if>
				<if test="introduce !=null"> introduce =#{introduce}, </if>
				<if test="tag !=null"> tag =#{tag}, </if>
				<if test="cover !=null"> cover =#{cover}, </if>
				<if test="isTop !=null and (isTop ==1 or isTop =='1')"> is_top =now(), </if>
				<if test="signUpId !=null"> JSON_ARRAY_APPEND(sign_up_ids, '$',#{signUpId}) </if>
			</set>	
			where id =#{id} <if test="level !=null and ( level ==2 or level == '2')"> and building_id =#{buildingId} </if>
		</update>
		
		<select id="getActivity" parameterType="java.util.Map" resultMap="getActivityMap">
			select <include refid="Base_Column_List" /> from activity where id =#{id}
		</select>
		
		<select id="getActivityList" parameterType="java.util.Map" resultMap="getActivityMap">
			select a.*,JSON_LENGTH(a.sign_up_ids) sign_up_num,b.name from activity a left join building b on a.building_id = b.id
			<where>
				  <if test="level !=null and ( level ==2 or level == '2')"> and building_id =#{buildingId} </if>
				<if test="type !=null and (type ==1 or type =='1')">and end_time >now</if>
				<if test="type !=null and (type ==2 or type =='2')">and end_time &lt;now</if>
			</where>
			
		</select>
		
		
		<select id="getActivityDetail" parameterType="java.util.Map" resultMap="getActivityDetailMap">
			select a.*,JSON_LENGTH(a.sign_up_ids) sign_up_num ,f.url, building_logo ,b.building_adress
				from activity a 
				left join building b on a.building_id =b.id
				left join file f on f.id = b.logo
		</select>
		
		
		<select id="getUserActivityList" parameterType="java.util.Map" resultMap="getUserActivityListMap">
			select a.*,b.building_adress
				from activity a 
				left join building b on a.building_id =b.id
				order by is_top desc ,end_time desc
		</select>

</mapper>